# Нэмэлт эрх олгох систем - Дэлгэрэнгүй заавар

## Тойм

Энэхүү систем нь аймаг/дүүрэг бүрээр ангилал тус бүрд нэмэлт эрх олгох боломжийг олгоно. Жагсаалтаас эрх авсан сурагчдаас гадна, босго оноонд хүрсэн сурагчдад "2.1 эрх нэмэлтээр" олгоно.

**Үндсэн зарчим**: Олимпиад бүр нэг ангилалд харгалзана. Тохиргооны файлд олон олимпиад (C, D, E, F гэх мэт) зааж өгснөөр нэг удаа бүгдийг боловсруулна.

---

## Алхам 1: Excel тохиргооны файл үүсгэх

### Аргууд:

#### А) Үндсэн ангиллалуудтай (C, D, E, F):
```bash
source /home/deploy/django/mmo/.venv/bin/activate
cd /home/deploy/django/mmo
python create_additional_quota_template.py
```

Үүнээр `additional_quota.xlsx` файл үүснэ.

#### Б) Олимпиадын ID-уудтай:
```bash
python create_additional_quota_template.py --olympiad-ids "C:10,D:11,E:12,F:13"
```

Энэ нь C ангилал = олимпиад 10, D ангилал = олимпиад 11 гэх мэт байдлаар template үүсгэнэ.

#### В) Өөр ангиллалуудтай:
```bash
python create_additional_quota_template.py --categories "Суурь,Дунд,Ахлах"
```

#### Г) Өөр нэртэй файл үүсгэх:
```bash
python create_additional_quota_template.py -o quota_2024.xlsx
```

---

## Алхам 2: Excel файл бөглөх

Үүссэн Excel файлыг нээж, 2 хэсгийг бөглөнө:

### 1. МЭДЭЭЛЭЛ ХЭСЭГ - Ангилал бүрийн олимпиадын ID

| Мэдээлэл          |               |
|-------------------|---------------|
| **Ангилал**       | **Олимпиадын ID** |
| C                 | 10            |
| D                 | 11            |
| E                 | 12            |
| F                 | 13            |

**Тайлбар:**
- Ангилал бүрт харгалзах олимпиадын ID-г оруулна
- Олимпиад бүр зөвхөн нэг ангилалд харгалзана
- Систем нь бүх ангиллалын олимпиадыг нэг удаа боловсруулна
- Бөглөөгүй ангиллал нь боловсруулагдахгүй (алгасна)

### 2. АЙМГУУД ХЭСЭГ - Аймаг бүрийн босго оноо

| Аймгууд |                  |   |   |   |   |
|---------|------------------|---|---|---|---|
| **ID**  | **Нэр**          | **C** | **D** | **E** | **F** |
| 1       | Архангай аймаг   |   |   |   |   |
| 15      | Сүхбаатар аймаг  | 4 | 3 | 5 |   |
| 16      | Сэлэнгэ аймаг    | 5 |   | 6 | 4 |
| 22      | Багануур дүүрэг  |   |   |   |   |

**Тайлбар:**
- Нэмэлт эрх олгохыг хүссэн аймаг/ангиллалын нүдэнд босго оноо оруулна
- **Жишээ нь:** Сүхбаатар аймгийн C ангилалд 4 гэж бичвэл:
  - Олимпиад 10 (C ангилал)-д оролцсон
  - Сүхбаатар аймгийн албан ёсны оролцогч
  - Жагсаалтаас (top 20) эрх аваагүй
  - Оноо ≥4 байх
  - → "2.1 эрх нэмэлтээр" эрх авна
- **Хоосон нүд = нэмэлт эрх олгохгүй**

---

## Алхам 3: Команд ажиллуулах

### Үндсэн команд:

```bash
source /home/deploy/django/mmo/.venv/bin/activate
cd /home/deploy/django/mmo

# Эхлээд dry-run хийж шалгах
python manage.py first_to_second_by_ranking \
  --config-file additional_quota.xlsx \
  --dry-run

# Зөв бол хадгалах
python manage.py first_to_second_by_ranking \
  --config-file additional_quota.xlsx
```

**Тэмдэглэл:**
- `--config-file` параметр заавал шаардлагатай
- Олимпиадын ID-г config файлаас авна
- Өмнөх хувилбартай харьцуулахад илүү энгийн, --olympiad-id гэх мэт нэмэлт параметр шаардлагагүй

---

## Үр дүн шалгах

### Dry-run хийхэд харагдах мэдээлэл:

```
✓ Тохиргоо уншигдлаа: additional_quota.xlsx
  Ангилал → Олимпиад: {'C': 10, 'D': 11, 'E': 12, 'F': 13}
  Нэмэлт эрхийн тохиргоо: 28 аймаг/дүүрэг

============================================================
Ангилал: C | Олимпиад ID: 10
============================================================

Олимпиад: 2-р давааны 1-р шат
Түвшин: C
Нийт оролцогч: 450
  Аймгийн оролцогч: 320
  Дүүргийн оролцогч: 130

  Сонгогдсон: 180
  Төрлөөр:
    2.1 эрх жагсаалтаас: 150
    2.1 эрх нэмэлтээр: 30

============================================================
Ангилал: D | Олимпиад ID: 11
============================================================
...

============================================================
НИЙТ ҮР ДҮН
============================================================

Нийт сонгогдсон: 680

--- Олимпиад/Ангиллаар ---
  C (ID=10): 180
  D (ID=11): 200
  E (ID=12): 150
  F (ID=13): 150

--- Төрлөөр ---
  2.1 эрх жагсаалтаас: 580
  2.1 эрх нэмэлтээр: 100

--- Аймаг/Дүүргээр (топ 10) ---
  Сүхбаатар аймаг: 45
  Сэлэнгэ аймаг: 38
  ...
```

### Хадгалсан үр дүн:

- **Award моделд** бүх олимпиадын "2.1 эрх жагсаалтаас" болон "2.1 эрх нэмэлтээр" бүртгэл үүснэ
- **ScoreSheet.prizes** талбарт тэмдэглэгдэнэ
- Хуучин 2.1 эрх бүгд устаад, шинээр үүснэ

---

## Бодит жишээ

### Жишээ 1: 4 олимпиад, тус бүр өөр ангилал

**Тохиргоо:**
```
МЭДЭЭЛЭЛ:
  C | 10
  D | 11
  E | 12
  F | 13

АЙМГУУД:
  15 | Сүхбаатар | 4 | 3 | 5 | 2
  16 | Сэлэнгэ   | 5 | 4 | 6 | 3
```

**Команд:**
```bash
python manage.py first_to_second_by_ranking \
  --config-file quota.xlsx
```

**Үр дүн:**
- **Олимпиад 10** (C ангилал):
  - Сүхбаатар аймаг: ≥4 оноотой → нэмэлт эрх
  - Сэлэнгэ аймаг: ≥5 оноотой → нэмэлт эрх
- **Олимпиад 11** (D ангилал):
  - Сүхбаатар аймаг: ≥3 оноотой → нэмэлт эрх
  - Сэлэнгэ аймаг: ≥4 оноотой → нэмэлт эрх
- **Олимпиад 12** (E ангилал):
  - Сүхбаатар аймаг: ≥5 оноотой → нэмэлт эрх
  - Сэлэнгэ аймаг: ≥6 оноотой → нэмэлт эрх
- **Олимпиад 13** (F ангилал):
  - Сүхбаатар аймаг: ≥2 оноотой → нэмэлт эрх
  - Сэлэнгэ аймаг: ≥3 оноотой → нэмэлт эрх

### Жишээ 2: Зарим ангилалд нэмэлт эрх олгохгүй

**Тохиргоо:**
```
МЭДЭЭЛЭЛ:
  C | 10
  D | 11

АЙМГУУД:
  15 | Сүхбаатар | 4 |   |
  16 | Сэлэнгэ   |   | 3 |
```

**Үр дүн:**
- **Олимпиад 10** (C): Зөвхөн Сүхбаатар нэмэлт эрх авна (Сэлэнгэ хоосон)
- **Олимпиад 11** (D): Зөвхөн Сэлэнгэ нэмэлт эрх авна (Сүхбаатар хоосон)

---

## Түгээмэл асуулт

### 1. Олимпиадын ID-г яаж олох вэ?

```bash
python manage.py shell
>>> from olympiad.models import Olympiad
>>> for o in Olympiad.objects.all():
...     print(f'{o.id}: {o.name} ({o.level.name})')
```

### 2. Олимпиад бүр яагаад нэг ангилалд харгалзах вэ?

Олимпиад модель нь `level` (түвшин/ангилал) талбартай. Нэг олимпиад нэг түвшинд харгалзана. Жишээ нь:
- Олимпиад 10: C ангилал
- Олимпиад 11: D ангилал

### 3. Хуучин нэмэлт эрх устахгүй юу?

Устана. Команд ажиллах бүрт config файлд дурдагдсан БҮХ олимпиадын "2.1"-ээр эхэлсэн award устгаад, дахин үүсгэнэ.

### 4. Дүүрэгт нэмэлт эрх олгож болох уу?

Болно. Аймгууд хэсэгт дүүргийн мөрүүд мөн байна (ID > 21). Дүүргийн босго оноог бөглөснөөр аймаг, дүүрэг аль аль нь ижил нэмэлт эрх авна.

### 5. Нэг аймагт зарим ангилал нэмэлт эрх, зарим нь үгүй гэж болох уу?

Болно. Хоосон нүд нь нэмэлт эрх олгохгүй гэсэн утга.

### 6. Жагсаалтаас эрх авсан сурагч нэмэлт эрх авах уу?

Үгүй. Жагсаалтаас (top 20/50) эрх авсан сурагч нэмэлт эрхийн тооцоонд ороохгүй (код: `first_to_second_by_ranking.py:89`).

### 7. 0 оноотой сурагч нэмэлт эрх авах уу?

Үгүй. 0 оноотой сурагчид автоматаар хасагдана (5.8-р заалт, код: `first_to_second_by_ranking.py:28`).

### 8. Босго оноо = тэнцүү оноотой сурагч нэмэлт эрх авах уу?

Тийм. Код: `score >= threshold_score` (>=, код: `first_to_second_by_ranking.py:154`).

### 9. Олон олимпиад хэрхэн боловсруулагддаг вэ?

Систем нь config файлаас бүх олимпиадын ID-г уншиж, тус бүрийг дараалан боловсруулна. Эцэст нь бүх үр дүнг нэгтгэж, нэг удаа хадгална.

---

## Алдаа засах

### Алдаа: "Тохиргооны файлд олимпиадын ID байхгүй байна"

**Шалтгаан:** Мэдээлэл хэсэг хоосон эсвэл буруу бөглөгдсөн
**Шийдэл:** Мэдээлэл хэсэгт ангилал бүрийн олимпиадын ID оруулна

### Алдаа: "Олимпиад ID=X олдсонгүй"

**Шалтгаан:** Мэдээлэл хэсэгт буруу олимпиадын ID
**Шийдэл:** Олимпиадын ID-г шалгана:
```bash
python manage.py shell -c "from olympiad.models import Olympiad; print(list(Olympiad.objects.values_list('id', 'name')))"
```

### Алдаа: "Онооны хуудас олдсонгүй"

**Шалтгаан:** Олимпиадад `is_official=True` ScoreSheet байхгүй
**Шийдэл:** ScoreSheet-үүдийг шалгана

### Алдаа: "usage: manage.py first_to_second_by_ranking [-h] --config-file CONFIG_FILE"

**Шалтгаан:** --config-file параметр өгөөгүй
**Шийдэл:** --config-file заавал шаардлагатай:
```bash
python manage.py first_to_second_by_ranking --config-file quota.xlsx
```

---

## Файлын бүтэц

```
/home/deploy/django/mmo/
├── additional_quota.xlsx                  # Тохиргооны файл
├── create_additional_quota_template.py    # Template үүсгэгч
├── ADDITIONAL_QUOTA_GUIDE.md              # Энэ заавар
├── QUICK_START.md                         # Богино заавар
└── olympiad/management/commands/
    └── first_to_second_by_ranking.py      # Үндсэн команд
```

---

## Техникийн дэлгэрэнгүй

### Excel файлын бүтэц:

**Мэдээлэл хэсэг:**
- Мөр 1: "Мэдээлэл" (header)
- Мөр 2: "Ангилал | Олимпиадын ID" (column names)
- Мөр 3+: Ангилал, олимпиадын ID

**Аймгууд хэсэг:**
- Мөр N: "Аймгууд" (header)
- Мөр N+1: "ID | Нэр | C | D | E | F" (column names)
- Мөр N+2+: Аймаг өгөгдөл

### Код логик:

1. **read_quota_config_file()**: Excel уншиж, {category: olympiad_id} болон quota config буцаана
2. **select_next_stage()**: Жагсаалтаас + нэмэлт эрх сонгоно (аймаг бүрээр)
3. **handle()**: Олимпиад бүрийг дараалан боловсруулж, үр дүнг нэгтгэж хадгална

### Олон олимпиад боловсруулах урсгал:

```
1. Config файл унших
   └─> {C: 10, D: 11, E: 12} + quota_df

2. Олимпиад бүрийг давталт
   ├─> Олимпиад 10 (C): ScoreSheet татах, эрх олгох
   ├─> Олимпиад 11 (D): ScoreSheet татах, эрх олгох
   └─> Олимпиад 12 (E): ScoreSheet татах, эрх олгох

3. Үр дүн нэгтгэх
   └─> Бүх олимпиадын selected-г нэгтгэнэ

4. Хадгалах
   ├─> Хуучин 2.1 award устгах (бүх олимпиадаас)
   ├─> Шинэ award үүсгэх
   └─> ScoreSheet.prizes шинэчлэх
```

---

## Өмнөх хувилбараас өөрчлөлт

### Хуучин хувилбар:
```bash
python manage.py first_to_second_by_ranking --olympiad-id 10 --additional-quota-file quota.xlsx
```
Нэг удаа нэг л олимпиад боловсруулдаг байсан.

### Шинэ хувилбар:
```bash
python manage.py first_to_second_by_ranking --config-file quota.xlsx
```
- Олимпиадын ID-г файлаас авна
- Нэг удаа олон олимпиад боловсруулна
- Илүү энгийн, параметр цөөн
- Олимпиад бүр нэг ангилалд харгалзана гэсэн зарчмыг дагана

---

## Холбоо барих

Асуулт, санал байвал системийн админд хандана уу.
