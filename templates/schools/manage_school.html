{% extends 'base.html' %}

{% block title %}Ангилал удирдах: {{ selected_level.name|default:"Ангилалгүй" }}{% endblock %}

{% block content %}
<div class="container-fluid mx-4">
        <a href="{% url 'school_dashboard' school_id=school.id %}" class="btn btn-outline-secondary btn-sm mb-3">« Удирдах самбар луу буцах</a>
        <h1 class="mb-4">Сургууль: {{ school.province.name }} - {{ school.name }}</h1>

        <hr>
        <!-- Хэрэглэгч хайх -->
        <h3>Хэрэглэгч хайж, сургуульд нэмэх</h3>
        <form method="POST" class="my-4">
            {% csrf_token %}
            {{ search_form.as_p }}
            <button type="submit" name="search_users" class="btn btn-primary">Хайх</button>
        </form>

        {% if search_results is not None %}
            <h3>Хайлтын үр дүн:</h3>
            {% if search_results %}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>MMO ID</th>
                                <th>Нэр</th>
                                <th>Сургууль</th>
                                <th>Үйлдэл</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in search_results %}
                                <tr>
                                    <td>{{ user.id }}</td>
                                    <td>{{ user.last_name }} {{ user.first_name }} ({{ user.username }})</td>
                                    <td>{{ user.data.province.name }}, {{ user.data.school }}</td>
                                    <td>
                                        <form method="POST" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="user_id" value="{{ user.id }}">
                                            <button type="submit" name="add_existing_user" class="btn btn-success btn-sm">Нэмэх</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                 <div class="alert alert-warning">Хайлтын илэрц олдсонгүй.</div>
            {% endif %}
        {% endif %}

        <hr>

        <!-- Шинэ хэрэглэгч нэмэх -->
        <h3>Шинэ хэрэглэгчийг сургуульд нэмэх</h3>
        <form method="POST">
            {% csrf_token %}
            <div class="mb-3">
                {{ add_user_form.as_table }}
            </div>
            <button type="submit" name="add_user" class="btn btn-primary">Шинэ хэрэглэгч нэмэх</button>
        </form>

    <hr>
        <!-- Сонгогдсон ангиллын сурагчдыг харуулах -->
        <h4 class="mt-4">Ангилал: {{ selected_level.name }} (Нийт: {{ users_in_level|length }} сурагч)</h4>
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>MMO ID</th>
                        <th>Овог</th>
                        <th>Нэр</th>
                        <th>Анги</th>
                        <th>Үйлдэл</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users_in_level %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ user.id }}</td>
                            <td>{{ user.last_name }}</td>
                            <td>{{ user.first_name }}</td>
                            <td>{{ user.data.grade.name|default:"Тодорхойгүй" }}</td>
                            <td>
                                <a href="{% url 'edit_user_in_group' user.id %}" class="btn btn-primary btn-sm">Бүртгэл</a>
                                <form method="POST" class="d-inline" onsubmit="return confirm('Энэ сурагчийг сургуулиас хасахдаа итгэлтэй байна уу?');">
                                    {% csrf_token %}
                                    <input type="hidden" name="user_id" value="{{ user.id }}">
                                    <button type="submit" name="remove_user" class="btn btn-danger btn-sm">Хасах</button>
                                </form>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">Энэ ангилалд сурагч алга байна.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
{% endblock %}
