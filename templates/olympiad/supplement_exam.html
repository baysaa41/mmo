{% extends 'base.html' %}

{% load crispy_forms_tags %}
{% load latex_filter %}

{% block title %}–ù—ç–º—ç–ª—Ç –º–∞—Ç–µ—Ä–∏–∞–ª –∏–ª–≥—ç—ç—Ö{% endblock %}

{% block menu %}{% endblock %}

{% block content %}
    <h3>üÜî ID: {{ contestant.id }} ‚Äî {{ contestant.first_name }} {{ contestant.last_name }}</h3>

    <p class="alert alert-info">
        –ù—ç–º—ç–ª—Ç –º–∞—Ç–µ—Ä–∏–∞–ª –∏–ª–≥—ç—ç—Ö “Ø–µ–¥ –∑—É—Ä–∞–≥ –Ω—å <strong>‚Äú–®–∞–ª–≥–∞–∂ –±–∞–π–Ω–∞‚Äù</strong> —Ç”©–ª”©–≤—Ç—ç–π —Ö–∞–¥–≥–∞–ª–∞–≥–¥–∞–Ω–∞.
        –•—ç—Ä—ç–≤ –∑”©–≤—à”©”©—Ä”©–≥–¥–≤”©–ª –≥–æ–ª –º–∞—Ç–µ—Ä–∏–∞–ª —Ä—É—É —à–∏–ª–∂–∏–Ω—ç. –¢–∞—Ç–≥–∞–ª–∑—Å–∞–Ω –º–∞—Ç–µ—Ä–∏–∞–ª —Ö–∞—Ä–∞–≥–¥–∞—Ö–≥“Ø–π.
    </p>

    <h4>üìò –ë–æ–¥–ª–æ–≥—É—É–¥</h4>

    {% autoescape off %}
    {% for result in results %}
        <div class="card mb-4 p-3">
            <div class="mb-2"><strong>{{ result.problem.order }}.</strong> {{ result.problem.statement|latex|linebreaksbr }}</div>

            <!-- ==== SUPPLEMENT UPLOAD LIST (LIVE) ==== -->
            <div id="uploaded-list-{{ result.id }}" class="mb-3">
                {% if result.get_supplements %}
                    <h6>üìé –ò–ª–≥—ç—ç—Å—ç–Ω –Ω—ç–º—ç–ª—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—É—É–¥:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% for upload in result.get_supplements %}
                            <div class="border p-1 rounded" style="width:90px; text-align:center;">
                                <img src="{{ upload.file.url }}" style="width: 100%; height: 70px; object-fit: cover;">
                                <div style="font-size: 0.7rem; margin-top:4px;">
                                    {% if upload.is_accepted %}
                                        <span class="badge bg-success">–ó”©–≤—à”©”©—Ä”©–≥–¥—Å”©–Ω</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">–®–∞–ª–≥–∞–∂ –±–∞–π–Ω–∞</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <!-- ==== AJAX FORM AREA ==== -->
            <div id="form-{{ result.id }}"></div>

            <button type="button" class="btn btn-primary btn-sm mt-2" onclick="openUploadForm({{ result.id }})">
                üì§ –ë–æ–¥–æ–ª—Ç –∏–ª–≥—ç—ç—Ö
            </button>
        </div>
    {% endfor %}
    {% endautoescape %}

    <script>
        function openUploadForm(resultId) {
            // clear all other forms
            document.querySelectorAll('[id^="form-"]').forEach(e => e.innerHTML = "");

            $.get('{% url "olympiad_get_result_form" %}', {
                result_id: resultId,
                is_supplement: true
            }, function (data) {
                document.getElementById('form-' + resultId).innerHTML = data;
            });
        }

        // CALL THIS AFTER SUCCESSFUL AJAX UPLOAD:
        function refreshUploadedList(resultId, items) {
            const container = document.getElementById("uploaded-list-" + resultId);

            let html = `<h6>üìé –ò–ª–≥—ç—ç—Å—ç–Ω –Ω—ç–º—ç–ª—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—É—É–¥:</h6><div class="d-flex flex-wrap gap-2">`;

            items.forEach(f => {
                html += `
                    <div class="border p-1 rounded" style="width:90px; text-align:center;">
                        <img src="${f.url}" style="width: 100%; height: 70px; object-fit: cover;">
                        <div style="font-size: 0.7rem; margin-top:4px;">
                            <span class="badge bg-warning text-dark">–®–∞–ª–≥–∞–∂ –±–∞–π–Ω–∞</span>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;

            container.innerHTML = html;
        }
    </script>

{% endblock %}
