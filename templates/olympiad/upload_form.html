{% load crispy_forms_filters %}

<div class="upload-form-container">
    <div class="upload-form-title">
        üìé –ë–æ–¥–ª–æ–≥–æ {{ result.problem.order }} ‚Äî –§–∞–π–ª —Å–æ–Ω–≥–æ—Ö
    </div>

    <form method="post" enctype="multipart/form-data" id="student-result-{{ result.id }}" action="{{ form_action_url }}">
        {% csrf_token %}
        {{ form|crispy }}

        <div class="file-info">
            üí° –ó”©–≤—Ö”©–Ω –∑—É—Ä–∞–≥ (.jpg, .png, .gif, .webp) —Ñ–æ—Ä–º–∞—Ç. –û–ª–æ–Ω –∑—É—Ä–∞–≥ –∑—ç—Ä—ç–≥ —Å–æ–Ω–≥–æ–∂ –±–æ–ª–Ω–æ. –§–∞–π–ª —Ç—É—Å –±“Ø—Ä 10MB-–∞–∞—Å –±–∞–≥–∞ –±–∞–π—Ö —ë—Å—Ç–æ–π.
        </div>

        <div class="upload-form-actions">
            <button type="submit" class="upload-submit-btn">‚úÖ –°–µ—Ä–≤–µ—Ä—Ç —Ö—É—É–ª–∞—Ö</button>
            <button type="button" class="upload-cancel-btn" onclick="cancelUpload({{ result.id }})">‚ùå –ë–æ–ª–∏—Ö</button>
        </div>
    </form>

    <div id="upload-results-{{ result.id }}" class="upload-results" style="display:none;"></div>
</div>

<script>
(function() {
    const formId = 'student-result-{{ result.id }}';
    const form = document.getElementById(formId);
    const resultsDiv = document.getElementById('upload-results-{{ result.id }}');

    if (!form) return;

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(form);
        const submitBtn = form.querySelector('.upload-submit-btn');
        const fileInput = form.querySelector('input[type="file"]');

        if (!fileInput.files.length) {
            alert('‚ö†Ô∏è –ó—É—Ä–∞–≥ —Å–æ–Ω–≥–æ–Ω–æ —É—É.');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerText = '‚è≥ –•—É—É–ª–∂ –±–∞–π–Ω–∞...';
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = '<p style="color:gray;">‚è≥ –§–∞–π–ª —Ö—É—É–ª–∂ –±–∞–π–Ω–∞...</p>';

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => res.json().then(data => ({status: res.status, data})))
        .then(resp => {
            submitBtn.disabled = false;
            submitBtn.innerText = '‚úÖ –°–µ—Ä–≤–µ—Ä—Ç —Ö—É—É–ª–∞—Ö';

            const data = resp.data;

            // ‚úÖ UI –¥—ç—ç—Ä “Ø—Ä –¥“Ø–Ω —Ö–∞—Ä—É—É–ª–∞—Ö
            resultsDiv.innerHTML = buildResultHTML(data);

            // ‚úÖ Supplement upload —Ö–∏–π—Ö “Ø–µ–¥ LIVE refresh
            if (data.success && typeof refreshUploadedList === "function" && '{{ is_supplement }}' === 'True') {
                refreshUploadedList({{ result.id }}, data.uploaded_files);
            }

            // ‚úÖ Exam upload —Ö–∏–π—Ö “Ø–µ–¥ list refresh (optional)
            if (data.success && typeof refreshUploadedUploads === "function" && '{{ is_supplement }}' === 'False') {
                refreshUploadedUploads({{ result.id }}, data.uploaded_files);
            }

            fileInput.value = '';
        })
        .catch(err => {
            console.error(err);
            resultsDiv.innerHTML = `<div class="upload-result-item upload-result-error">‚ùå –ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${err}</div>`;
            submitBtn.disabled = false;
            submitBtn.innerText = '‚úÖ –°–µ—Ä–≤–µ—Ä—Ç —Ö—É—É–ª–∞—Ö';
        });
    });

    function buildResultHTML(data) {
        let html = '';

        if (data.uploaded_files?.length) {
            html += `<div><strong style="color:#10b981;">‚úÖ –ê–º–∂–∏–ª—Ç—Ç–∞–π:</strong>`;
            data.uploaded_files.forEach(f => {
                html += `<div class="upload-result-item upload-result-success">üìÑ ${f.name}</div>`;
            });
            html += '</div>';
        }

        if (data.failed_files?.length) {
            html += `<div style="margin-top:.5rem;"><strong style="color:#ef4444;">‚ùå –ê–º–∂–∏–ª—Ç–≥“Ø–π:</strong>`;
            data.failed_files.forEach(f => {
                html += `<div class="upload-result-item upload-result-error">üìÑ ${f.name}<br><small>${f.reason}</small></div>`;
            });
            html += '</div>';
        }

        html += `<p style="margin-top:1rem; font-weight:bold;">${data.message}</p>`;
        return html;
    }
})();

function cancelUpload(id) {
    document.getElementById('form-' + id).innerHTML = '';
}
</script>
