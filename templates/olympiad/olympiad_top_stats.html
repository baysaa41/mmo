{% extends "base.html" %}
{% block content %}
    <h2>{{ olympiad.name }}, {{ olympiad.level.name }} ангилал – Статистик</h2>

    <!-- Сонголтын меню -->
    {% include "selection_menu.html" %}

    <div class="my-3">
        <a href="{% url 'olympiad_result_view' olympiad.id %}{% if selected_province != '0' %}?p=
            {{ selected_province }}{% elif selected_zone != '0' %}?z={{ selected_zone }}{% endif %}"
           class="btn btn-primary me-2">
            ← Жагсаалт харах
        </a>
        <a href="{% url 'olympiad_results_home' %}?year={{ olympiad.school_year.id }}"
           class="btn btn-outline-primary">
            Олимпиадын жагсаалт
        </a>
    </div>

    <div class="row">
        <!-- Зүүн багана -->
        <div class="col-md-6 mb-4">
            <h3>Эхний {{ top_name_50 }} байр – Сургууль</h3>
            <small class="text-muted">Эхний {{ top_name_50 }} байр болон түүнтэй тэнцүү оноо авсан сурагчдын тоо
                сургуулиар</small>
            <table class="table table-bordered mt-2">
                <colgroup>
                    <col style="width:60%">
                    <col style="width:40%">
                </colgroup>
                <tr>
                    <th>Сургууль</th>
                    <th>Сурагчдын тоо</th>
                </tr>
                {% for row in top50_by_school %}
                    <tr>
                        <td>{{ row.school__name }}</td>
                        <td>{{ row.count }}</td>
                    </tr>
                {% endfor %}
                <tr>
                    <th>Нийт</th>
                    <th>{{ top50_count }} сурагч</th>
                </tr>
            </table>
        </div>

        <!-- Баруун багана -->
        <div class="col-md-6 mb-4">
            <h3>Эхний {{ top_name_30 }} байр – Аймаг/Дүүрэг</h3>
            <small class="text-muted">Эхний {{ top_name_30 }} байр болон түүнтэй тэнцүү оноо авсан сурагчдын тоо
                аймаг/дүүргээр</small>
            <table class="table table-bordered mt-2">
                <colgroup>
                    <col style="width:60%">
                    <col style="width:40%">
                </colgroup>
                <tr>
                    <th>Аймаг/Дүүрэг</th>
                    <th>Сурагчдын тоо</th>
                </tr>
                {% for row in top30_by_province %}
                    <tr>
                        <td>{{ row.user__data__province__name }}</td>
                        <td>{{ row.count }}</td>
                    </tr>
                {% endfor %}
                <tr>
                    <th>Нийт</th>
                    <th>{{ top30_count }} сурагч</th>
                </tr>
            </table>
            <h3>Эхний {{ top_name_30 }} байр – Бүс</h3>
            <table class="table table-bordered mt-2">
                <colgroup>
                    <col style="width:60%">
                    <col style="width:40%">
                </colgroup>
                <tr>
                    <th>Бүс</th>
                    <th>Сурагчдын тоо</th>
                </tr>
                {% for row in top30_by_zone %}
                    <tr>
                        <td>{{ row.user__data__province__zone__name }}</td>
                        <td>{{ row.count }}</td>
                    </tr>
                {% endfor %}
                <tr>
                    <th>Нийт</th>
                    <th>{{ top30_count }} сурагч</th>
                </tr>
            </table>
        </div>
    </div>

    <!-- Нийлбэр онооны гистограмм -->
    <div class="row mt-5">
        <div class="col-12">
            <h3>Нийлбэр онооны тархалт</h3>
            <small class="text-muted">Нийлбэр оноо бүрээр хэдэн сурагч авсан байдал</small>
            <div style="width: 100%; height: 500px; margin-top: 20px;">
                <canvas id="scoreHistogram"></canvas>
            </div>
        </div>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const ctx = document.getElementById('scoreHistogram').getContext('2d');

            // View-с дамжуулсан өгөгдөл
            const scoreLabels = {{ score_labels|safe }};
            const scoreCounts = {{ score_counts|safe }};

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: scoreLabels,
                    datasets: [{
                        label: 'Сурагчдын тоо',
                        data: scoreCounts,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Нийлбэр оноо'
                            },
                            ticks: {
                                autoSkip: true,
                                maxRotation: 90,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Сурагчдын тоо'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return 'Оноо: ' + context[0].label;
                                },
                                label: function(context) {
                                    return 'Сурагчдын тоо: ' + context.parsed.y;
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}
