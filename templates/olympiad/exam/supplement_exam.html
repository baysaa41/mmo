{% extends 'base.html' %}
{% load static latex_filter %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" />
<style>
    :root {
        --primary: #2563eb;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-600: #4b5563;
        --gray-800: #1f2937;
    }
    body { background: var(--gray-50); }
    .exam-container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
    .exam-header {
        background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .exam-title { font-size: 1.5rem; font-weight: 600; color: var(--gray-800); margin-bottom: 0.5rem; }
    .exam-meta { display: flex; gap: 1.5rem; flex-wrap: wrap; color: var(--gray-600); font-size: 0.9rem; }
    .instructions {
        background: #fef3c7; border-left: 4px solid var(--warning);
        padding: 1rem; border-radius: 8px; margin-bottom: 2rem; font-size: 0.9rem;
    }
    .problem-card {
        background: white; border-radius: 12px; padding: 2rem; margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .problem-number {
        display: inline-block; background: var(--primary); color: white; font-weight: 600;
        padding: 0.5rem 1rem; border-radius: 8px; margin-bottom: 1rem;
    }
    .problem-statement { font-size: 1.05rem; line-height: 1.7; color: var(--gray-800); margin-bottom: 1.5rem; }
    .uploads-section {
        background: var(--gray-50); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;
    }
    .thumb img {
        width: 100px; height: 100px; object-fit: cover; border-radius: 6px; margin: 3px; border: 1px solid #ddd;
    }
    .btn-back {
        padding: .7rem 1.4rem; font-size: .9rem; border-radius: 6px;
        background: var(--gray-600); color: white; border: none; cursor: pointer;
        text-decoration: none; display: inline-block; margin-top: 2rem;
    }
    .btn-back:hover { background: var(--gray-800); }
</style>
{% endblock %}


{% block content %}
<div class="container">
    <div class="exam-container">

        {% csrf_token %}

        <div class="exam-header">
            <div class="exam-title">üìé –ù—ç–º—ç–ª—Ç –º–∞—Ç–µ—Ä–∏–∞–ª –æ—Ä—É—É–ª–∞—Ö</div>
            <div class="exam-meta">
                <span>{{ olympiad.name }}</span>
                <span>üë§ {{ contestant.first_name }}, {{ contestant.last_name }}</span>
            </div>
        </div>

        <div class="instructions">
            <strong>üìù –ê–Ω—Ö–∞–∞—Ä—É—É–ª–≥–∞:</strong> –¢–∞ —ç–Ω–¥ –∑”©–≤—Ö”©–Ω –Ω—ç–º—ç–ª—Ç –Ω–æ—Ç–æ–ª–≥–æ–æ, —Ç–∞–π–ª–±–∞—Ä, –∑—É—Ä–∞–≥, —Ñ–∞–π–ª –æ—Ä—É—É–ª–Ω–∞.
            <br>–≠–Ω—ç –º–∞—Ç–µ—Ä–∏–∞–ª –Ω—å <b>–±–∞—Ç–∞–ª–≥–∞–∞–∂–∞–∞–≥“Ø–π</b> (is_accepted=False) —Ç”©–ª”©–≤—Ç—ç–π —Ö–∞–¥–≥–∞–ª–∞–≥–¥–∞–∂, –∑”©–≤—Ö”©–Ω –±–∞–≥—à/—à“Ø“Ø–≥—á –∑”©–≤—à”©”©—Ä—Å–Ω–∏–π –¥–∞—Ä–∞–∞ —Ö“Ø—á–∏–Ω—Ç—ç–π –±–æ–ª–Ω–æ.
        </div>

        {% autoescape off %}
        {% for result in results %}
        <div class="problem-card">
            <div class="problem-number">–ë–æ–¥–ª–æ–≥–æ {{ result.problem.order }}</div>

            <div class="problem-statement">{{ result.problem.statement|latex|linebreaksbr }}</div>

            <!-- ‚úÖ UPLOADED FILES LIST -->
            <div id="uploaded-list-{{ result.id }}">
                {% include 'olympiad/exam/uploaded_list.html' with result=result %}
            </div>

            <div id="supplement-list-{{ result.id }}">
                {% include 'olympiad/exam/supplement_list.html' with result=result %}
            </div>

            <div class="dropzone" id="supplement-dropzone-{{ result.id }}"></div>

            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    var dropzoneId = "#supplement-dropzone-{{ result.id }}";
                    var resultId = "{{ result.id }}";
                    var postUrl = "{% url 'student_supplement_view' olympiad_id=olympiad.id %}";

                    // –≠–Ω—ç —Ö—ç—Å–≥—ç—ç—Å CSRF —Ç–æ–∫–µ–Ω–∏–π–≥ —É–Ω—à–∏–Ω–∞
                    var csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    new Dropzone(dropzoneId, {
                        url: postUrl,
                        paramName: "file",
                        maxFilesize: 10,
                        acceptedFiles: ".jpg,.jpeg,.png,.gif,.webp",

                        // 400 –∞–ª–¥–∞–∞–≥ –∑–∞—Å—á –±—É–π —Ö—ç—Å—ç–≥ (result_id)
                        params: {
                            'result_id': resultId
                        },

                        // 403 –∞–ª–¥–∞–∞–≥ –∑–∞—Å—á –±—É–π —Ö—ç—Å—ç–≥ (CSRF Token)
                        headers: {
                            'X-CSRFToken': csrftoken
                        },

                        // –ê–º–∂–∏–ª—Ç—Ç–∞–π –±–æ–ª—Å–Ω—ã –¥–∞—Ä–∞–∞ –∂–∞–≥—Å–∞–∞–ª—Ç—ã–≥ –¥–∞—Ö–∏–Ω –∞—á–∞–∞–ª–Ω–∞
                        success: function(file, response) {
                            if (response && response.success) {
                                loadSuppplements(resultId);
                            }
                            this.removeFile(file);
                        },

                        // –ê–ª–¥–∞–∞ –≥–∞—Ä–≤–∞–ª —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–¥ —Ö–∞—Ä—É—É–ª–Ω–∞
                        error: function(file, message) {
                            console.error("Dropzone error:", message);
                            var errorMsg = "–§–∞–π–ª –∏–ª–≥—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.";
                            if (typeof message === "object" && message.message) {
                                errorMsg = "–ê–ª–¥–∞–∞: " + message.message;
                            } else if (typeof message === "string") {
                                errorMsg = message.includes("CSRF token missing") ? "–ê–ª–¥–∞–∞: CSRF —Ç–æ–∫–µ–Ω –æ–ª–¥—Å–æ–Ω–≥“Ø–π." : message;
                            }
                            alert(errorMsg);
                             this.removeFile(file);
                        }
                    });
                });
            </script>
            </div>
        {% endfor %}
        {% endautoescape %}

        <a href="{% url 'olympiad_home' %}" class="btn-back">‚¨Ö –ë—É—Ü–∞—Ö</a>

    </div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>

<script>
    // Dropzone-–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –∞–∂–∏–ª–ª–∞—Ö—ã–≥ –∑–æ–≥—Å–æ–æ–Ω–æ
    Dropzone.autoDiscover = false;


    function loadUploads(resultId) {
        $("#uploaded-list-" + resultId).load(
            "/olympiads/exam/uploads/" + resultId + "/"
        );
    }

    // –≠–Ω—ç —Ñ—É–Ω–∫—Ü –Ω—å 'supplement-list.html'-–≥ –¥–∞—Ö–∏–Ω –∞—á–∞–∞–ª–∞—Ö–∞–¥ –∞—à–∏–≥–ª–∞–≥–¥–∞–Ω–∞
    function loadSuppplements(resultId) {
        var listContainerId = "#supplement-list-" + resultId;
        $(listContainerId).load("/olympiads/exam/supplements/list/" + resultId + "/");
    }
</script>
{% endblock %}