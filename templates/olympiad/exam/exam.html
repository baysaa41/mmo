{% extends 'base.html' %}
{% load static latex_filter %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" />
<style>
    :root {
        --primary: #2563eb;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-600: #4b5563;
        --gray-800: #1f2937;
    }
    body { background: var(--gray-50); }
    .exam-container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
    .exam-header {
        background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .exam-title { font-size: 1.5rem; font-weight: 600; color: var(--gray-800); margin-bottom: 0.5rem; }
    .exam-meta { display: flex; gap: 1.5rem; flex-wrap: wrap; color: var(--gray-600); font-size: 0.9rem; }
    .instructions {
        background: #fef3c7; border-left: 4px solid var(--warning);
        padding: 1rem; border-radius: 8px; margin-bottom: 2rem; font-size: 0.9rem;
    }
    .problem-card {
        background: white; border-radius: 12px; padding: 2rem; margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); transition: box-shadow 0.2s;
    }
    .problem-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .problem-number {
        display: inline-block; background: var(--primary); color: white; font-weight: 600;
        padding: 0.5rem 1rem; border-radius: 8px; margin-bottom: 1rem;
    }
    .problem-statement { font-size: 1.05rem; line-height: 1.7; color: var(--gray-800); margin-bottom: 1.5rem; }
    .uploads-section {
        background: var(--gray-50); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;
    }
    .thumb img {
        width: 100px; height: 100px; object-fit: cover; border-radius: 6px; margin: 3px; border: 1px solid #ddd;
    }
    .submit-section {
        background: white; border-radius: 12px; padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; margin-top: 2rem;
    }
    .submit-btn {
        background: var(--success); color: white; padding: 1rem 3rem; border: none; border-radius: 8px;
        font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .submit-btn:hover { background: #059669; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
</style>
{% endblock %}


{% block content %}
<div class="container">
    <div class="exam-container">

        <!-- Header -->
        <div class="exam-header">
            <div class="exam-title">{{ olympiad.name }} - –®–∞–ª–≥–∞–ª—Ç</div>
            <div class="exam-meta">
                <span>üÜî ID: {{ contestant.id }}</span>
                <span>üë§ {{ contestant.first_name }}, {{ contestant.last_name }}</span>
            </div>
            {% if olympiad.description %}
                <div style="margin-top: 1rem; color: var(--gray-600); font-size: 0.9rem;">
                    {% autoescape off %}{{ olympiad.description }}{% endautoescape %}
                </div>
            {% endif %}
        </div>

        <!-- Instructions -->
        <div class="instructions"><strong>‚ö†Ô∏è –ê–Ω—Ö–∞–∞—Ä—É—É–ª–≥–∞:</strong> –ë–æ–¥–æ–ª—Ç–æ–æ –∑—É—Ä–∞–≥ —Ö—ç–ª–±—ç—Ä—ç—ç—Ä –æ—Ä—É—É–ª–Ω–∞ —É—É.</div>

        <!-- Problems -->
        {% autoescape off %}
        {% for result in results %}
        <div class="problem-card">
            <div class="problem-number">–ë–æ–¥–ª–æ–≥–æ {{ result.problem.order }}</div>
            <div class="problem-statement">{{ result.problem.statement|latex|linebreaksbr }}</div>

            <!-- ‚úÖ UPLOADED FILES LIST -->
            <div id="uploaded-list-{{ result.id }}">
                {% include 'olympiad/exam/uploaded_list.html' with result=result %}
            </div>

            <!-- ‚úÖ DROPZONE Upload area -->
            <div class="dropzone" id="dropzone-{{ result.id }}"></div>

            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    initDropzone(
                        "#dropzone-{{ result.id }}",
                        "{{ result.id }}",
                        "{% url 'upload_api' %}",
                        function () { loadUploads({{ result.id }}); }
                    );
                });
            </script>

        </div>
        {% endfor %}
        {% endautoescape %}

        <!-- ‚úÖ Submit Final -->
        <div class="submit-section">
            <button type="button" class="submit-btn" id="final-submit">‚úÖ –®–∞–ª–≥–∞–ª—Ç –¥—É—É—Å–≥–∞—Ö</button>
            <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--gray-600);">
                –ë“Ø—Ö –±–æ–¥–ª–æ–≥–æ–æ –∏–ª–≥—ç—ç—Å–Ω–∏–π –¥–∞—Ä–∞–∞ —ç–Ω—ç —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–Ω–∞ —É—É.
            </p>
        </div>

    </div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<script src="{% static 'js/dropzone.init.js' %}"></script>

<script>
function loadUploads(resultId) {
    $("#uploaded-list-" + resultId).load(
        "/olympiads/exam/uploads/" + resultId + "/"
    );
}
document.getElementById("final-submit").addEventListener("click", function () {
    if (confirm("–¢–∞ —à–∞–ª–≥–∞–ª—Ç—ã–≥ –¥—É—É—Å–≥–∞—Ö–¥–∞–∞ –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?")) {
        window.location.href = "{% url 'contest_end' olympiad_id=olympiad.id %}";
    }
});
</script>
{% endblock %}
