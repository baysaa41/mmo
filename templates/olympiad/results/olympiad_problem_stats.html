{% extends "base.html" %}
{% load latex_filter %}

{% block title %}{{ olympiad.name }} – Бодлогын статистик{% endblock %}

{% block content %}
    <div class="container my-4">
        <h2>{{ olympiad.name }}, {{ olympiad.level.name }} – Бодлогын статистик</h2>

        {% for ps in problem_stats %}
            <div class="card mb-4">
                <div class="card-header">
                    №{{ ps.problem.order }} – {{ ps.problem.statement|latex }}
                </div>
                <div class="card-body">
                    <!-- Нэгдсэн статистик -->
                    <p class="mb-3">
                        <strong>Оролцсон:</strong> {{ ps.stats.submissions }} |
                        <strong>Дундаж:</strong> {{ ps.stats.avg|default:"-"|floatformat:2 }} |
                        <strong>Max:</strong> {{ ps.stats.max|default:"-" }} |
                        <strong>Min:</strong> {{ ps.stats.min|default:"-" }}
                    </p>

                    <!-- Аймгуудын chart -->
                    <canvas id="chart-problem-{{ ps.problem.id }}" height="150"></canvas>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        {% for ps in problem_stats %}
            (function () {
                const ctx = document.getElementById("chart-problem-{{ ps.problem.id }}").getContext("2d");

                const labels = [
                    {% for row in ps.province_stats %}
                        "{{ row.province|slice:":21" }}",
                    {% endfor %}
                ];
                const fullData = [
                    {% for row in ps.province_stats %}
                        {{ row.full }},
                    {% endfor %}
                ];
                const gtZeroData = [
                    {% for row in ps.province_stats %}
                        {{ row.gt_zero }},
                    {% endfor %}
                ];
                const totalData = [
                    {% for row in ps.province_stats %}
                        {{ row.total }},
                    {% endfor %}
                ];

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Бүтэн оноо',
                                data: fullData,
                                backgroundColor: 'rgba(220, 53, 69, 0.7)', // danger өнгө
                                borderColor: 'rgba(220, 53, 69, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '0-ээс их оноо',
                                data: gtZeroData,
                                backgroundColor: 'rgba(255, 152, 0, 0.7)',   // orange
                                borderColor: 'rgba(255, 152, 0, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Нийт оролцогч',
                                data: totalData,
                                backgroundColor: 'rgba(76, 175, 80, 0.7)',   // green
                                borderColor: 'rgba(76, 175, 80, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {position: 'top'},
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {display: true, text: 'Хүний тоо'}
                            },
                            x: {
                                ticks: {autoSkip: false, maxRotation: 90, minRotation: 45}
                            }
                        }
                    }
                });
            })();
        {% endfor %}
    </script>
{% endblock %}
