{% extends 'base.html' %}

{% block title %}Шударга өрсөлдөөний шинжилгээ - {{ olympiad.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-3">
        <i class="fas fa-search"></i> Шударга өрсөлдөөний шинжилгээ
    </h2>
    <p class="lead text-muted">{{ olympiad.name }}, {{ olympiad.level.name }}</p>

    <div class="alert alert-info">
        <strong>Статистикийн тайлбар:</strong>
        <ul class="mb-0">
            <li><strong>CPS (Correlation Prevalence Score)</strong> - Сурагч хосуудын хариултын ижил байдлын индексийн дундаж (0-1). Томъёо: <code>0.65 × зөв_хариулт_ижил + 1 × буруу_хариулт_ижил</code></li>
            <li><strong>HRP (High Risk Pairs)</strong> - Индекс > 0.7 байгаа хосуудын эзлэх хувь</li>
            <li><strong>Clusters</strong> - Hierarchical clustering ашиглан ижил хариулттай бүлгүүдийн тоо (distance threshold = 0.5)</li>
            <li><strong>Integrity</strong> - Шударга байдлын оноо = 1 - CPS</li>
        </ul>
        <hr class="my-2">
        <strong>Үнэлгээ (Integrity Score-оор):</strong>
        <ul class="mb-0">
            <li><span class="badge bg-success">Сайн</span> - Integrity ≥ 0.7 (CPS ≤ 0.3)</li>
            <li><span class="badge bg-warning text-dark">Анхаарах</span> - Integrity ≥ 0.5 (CPS ≤ 0.5)</li>
            <li><span class="badge bg-danger">Эрсдэлтэй</span> - Integrity < 0.5 (CPS > 0.5)</li>
        </ul>
        <hr class="my-2">
        <small class="text-muted">
            <strong>Алгоритм:</strong> Сургууль бүрийн <strong>хамгийн өндөр оноотой 10 сурагч</strong>-ийн хариултыг харьцуулж, ижил байдлыг тооцно.
            AgglomerativeClustering ашиглан ойролцоо хариулттай сурагчдыг бүлэглэнэ.
        </small>
    </div>

    <!-- Olympiad & Province Selector -->
    <div class="card mb-4">
        <div class="card-body">
            <!-- Ангилал сонголт -->
            <div class="mb-3">
                <strong>Ангилал:</strong>
                <div class="btn-group ms-2" role="group">
                    <a href="{% url 'cheating_analysis' 191 %}{% if selected_province_id %}?p={{ selected_province_id }}{% endif %}"
                       class="btn btn-sm {% if olympiad.id == 191 %}btn-primary{% else %}btn-outline-primary{% endif %}">C</a>
                    <a href="{% url 'cheating_analysis' 192 %}{% if selected_province_id %}?p={{ selected_province_id }}{% endif %}"
                       class="btn btn-sm {% if olympiad.id == 192 %}btn-primary{% else %}btn-outline-primary{% endif %}">D</a>
                    <a href="{% url 'cheating_analysis' 193 %}{% if selected_province_id %}?p={{ selected_province_id }}{% endif %}"
                       class="btn btn-sm {% if olympiad.id == 193 %}btn-primary{% else %}btn-outline-primary{% endif %}">E</a>
                    <a href="{% url 'cheating_analysis' 194 %}{% if selected_province_id %}?p={{ selected_province_id }}{% endif %}"
                       class="btn btn-sm {% if olympiad.id == 194 %}btn-primary{% else %}btn-outline-primary{% endif %}">F</a>
                </div>
            </div>

            <form method="get" class="row g-3 align-items-center">
                <div class="col-auto">
                    <label class="form-label mb-0"><strong>Аймаг/Дүүрэг:</strong></label>
                </div>
                <div class="col-auto">
                    <select name="p" class="form-select" onchange="this.form.submit()">
                        <option value="">-- Сонгоно уу --</option>
                        {% for province in provinces %}
                            <option value="{{ province.id }}" {% if province.id == selected_province_id %}selected{% endif %}>
                                {{ province.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">Харах</button>
                </div>
                {% if selected_province_id %}
                <div class="col-auto">
                    <a href="?" class="btn btn-outline-secondary">Цэвэрлэх</a>
                </div>
                {% endif %}
                <div class="col-auto ms-auto">
                    <a href="?p={{ selected_province_id }}&refresh=1" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> Шинэчлэх
                    </a>
                </div>
            </form>
        </div>
    </div>

    {% if selected_province_id %}
        {% if results %}
        <div class="card">
            <div class="card-header">
                <strong>{{ selected_province_name }}</strong> - {{ total_schools }} сургууль
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 5%">#</th>
                                <th style="width: 35%">Сургууль</th>
                                <th class="text-center" style="width: 8%">Сурагч</th>
                                <th class="text-center" style="width: 10%">CPS</th>
                                <th class="text-center" style="width: 8%">HRP</th>
                                <th class="text-center" style="width: 10%">Clusters</th>
                                <th class="text-center" style="width: 10%">Integrity</th>
                                <th class="text-center" style="width: 14%">Үнэлгээ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in results %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <a href="{% url 'olympiad_answer_view' olympiad.id %}?p={{ item.province_id }}&s={{ item.school_id }}&top=10">
                                        {{ item.school_name }}
                                    </a>
                                </td>
                                <td class="text-center">{{ item.student_count }}</td>
                                <td class="text-center">
                                    <span class="badge {% if item.CPS > 0.5 %}bg-danger{% elif item.CPS > 0.3 %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                        {{ item.CPS }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    {% if item.HRP > 0 %}
                                        <span class="text-danger">{{ item.HRP|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-muted">0</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if item.ClusterCount > 1 %}
                                        <span class="badge bg-info">{{ item.ClusterCount }}</span>
                                    {% else %}
                                        <span class="text-muted">{{ item.ClusterCount }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <strong>{{ item.IntegrityScore }}</strong>
                                </td>
                                <td class="text-center">
                                    {% if item.IntegrityScore >= 0.7 %}
                                        <span class="badge bg-success">Сайн</span>
                                    {% elif item.IntegrityScore >= 0.5 %}
                                        <span class="badge bg-warning text-dark">Анхаарах</span>
                                    {% else %}
                                        <span class="badge bg-danger">Эрсдэлтэй</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning">
            Сонгосон аймаг/дүүрэгт шинжилгээ хийх өгөгдөл олдсонгүй.
        </div>
        {% endif %}
    {% else %}
    <div class="alert alert-light">
        Аймаг/дүүрэг сонгоно уу.
    </div>
    {% endif %}
</div>
{% endblock %}
