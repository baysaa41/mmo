{% extends 'base.html' %}
{% load static %}

{% block title %}Нэгтгэх хүсэлт #{{ merge_request.id }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-compress-arrows-alt"></i> Нэгтгэх хүсэлт #{{ merge_request.id }}</h2>
            <p class="text-muted mb-0">
                {{ merge_request.requesting_user.last_name }} {{ merge_request.requesting_user.first_name }}
                ({{ merge_request.created_at|date:"Y-m-d H:i" }})
            </p>
        </div>
        <div>
            {% if merge_request.status == 'pending' %}
            <span class="badge bg-warning fs-6">{{ merge_request.get_status_display }}</span>
            {% elif merge_request.status == 'completed' %}
            <span class="badge bg-success fs-6">{{ merge_request.get_status_display }}</span>
            {% elif merge_request.status == 'rejected' %}
            <span class="badge bg-danger fs-6">{{ merge_request.get_status_display }}</span>
            {% elif merge_request.status == 'failed' %}
            <span class="badge bg-dark fs-6">{{ merge_request.get_status_display }}</span>
            {% endif %}
        </div>
    </div>

    <!-- Request Reason -->
    {% if merge_request.reason %}
    <div class="card mb-3">
        <div class="card-header">
            <strong>Шалтгаан:</strong>
        </div>
        <div class="card-body">
            {{ merge_request.reason }}
        </div>
    </div>
    {% endif %}

    <!-- Requester's selections -->
    {% if saved_field_selections %}
    <div class="card mb-3 border-info">
        <div class="card-header bg-info text-white">
            <strong><i class="fas fa-user-edit"></i> Хүсэлт илгээгчийн сонголт</strong>
        </div>
        <div class="card-body">
            <table class="table table-sm mb-0">
                <tbody>
                    {% for sel in saved_selections_display %}
                    <tr>
                        <td width="150"><strong>{{ sel.label }}</strong></td>
                        <td>{{ sel.value }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- User Confirmation Status -->
    {% if merge_request.requires_user_confirmation %}
    <h4 class="mt-4">Баталгаажуулалтын статус</h4>
    <div class="card mb-3">
        <div class="card-body">
            {% with stats=merge_request.get_confirmation_stats %}
            <div class="row">
                <div class="col-md-3">
                    <div class="text-center">
                        <h5 class="text-success">{{ stats.confirmed }}</h5>
                        <small class="text-muted">Зөвшөөрсөн</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h5 class="text-warning">{{ stats.pending }}</h5>
                        <small class="text-muted">Хүлээгдэж буй</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h5 class="text-danger">{{ stats.rejected }}</h5>
                        <small class="text-muted">Татгалзсан</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h5 class="text-primary">{{ stats.total }}</h5>
                        <small class="text-muted">Нийт</small>
                    </div>
                </div>
            </div>
            {% endwith %}

            {% if merge_request.is_all_confirmed %}
            <div class="alert alert-success mt-3 mb-0">
                <i class="fas fa-check-circle"></i> Бүх хэрэглэгч баталгаажуулсан!
            </div>
            {% endif %}
        </div>
    </div>

    <h4>Хэрэглэгч бүрийн баталгаажуулалт</h4>
    <div class="table-responsive mb-4">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Хэрэглэгч</th>
                    <th>Имэйл</th>
                    <th>Статус</th>
                    <th>Огноо</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>
                        <strong>{{ user.last_name }} {{ user.first_name }}</strong>
                        <br><small class="text-muted">ID: {{ user.id }}</small>
                    </td>
                    <td>{{ user.email|default:"Имэйл байхгүй" }}</td>
                    <td>
                        {% if user.confirmation.status == 'confirmed' %}
                        <span class="badge bg-success"><i class="fas fa-check"></i> Зөвшөөрсөн</span>
                        {% elif user.confirmation.status == 'rejected' %}
                        <span class="badge bg-danger"><i class="fas fa-times"></i> Татгалзсан</span>
                        {% elif user.confirmation.status == 'pending' %}
                        <span class="badge bg-warning"><i class="fas fa-clock"></i> Хүлээгдэж байна</span>
                        {% else %}
                        <span class="badge bg-secondary">Мэдээлэл алга</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.confirmation.confirmed_at %}
                        {{ user.confirmation.confirmed_at }}
                        {% elif user.confirmation.rejected_at %}
                        {{ user.confirmation.rejected_at }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Olympiad Participation -->
    <h4 class="mt-4">Олимпиадад оролцсон түүх</h4>
    <div class="row">
        {% for user in users %}
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <strong>Хэрэглэгч #{{ user.id }}</strong> - {{ user.last_name }} {{ user.first_name }}
                    {% if user.id == primary_id %}
                    <span class="badge bg-primary">Үндсэн</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% for uid, data in user_olympiads.items %}
                        {% if uid == user.id %}
                            <p><strong>Нийт олимпиад:</strong> {{ data.olympiad_count }}</p>
                            {% if data.scoresheets %}
                            <p class="mb-1"><strong>Онооны хуудас:</strong></p>
                            <ul class="small">
                                {% for sheet in data.scoresheets|slice:":5" %}
                                <li>{{ sheet.olympiad.name }} - Оноо: {{ sheet.total }}</li>
                                {% endfor %}
                                {% if data.scoresheets.count > 5 %}
                                <li><em>...ба бусад {{ data.scoresheets.count|add:"-5" }}</em></li>
                                {% endif %}
                            </ul>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Review Section (Staff Only) -->
    {% if request.user.is_staff and merge_request.status == 'pending' %}

    {% if users|length < merge_request.user_ids|length %}
    <div class="alert alert-danger" role="alert">
        <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Нэгтгэх боломжгүй</h5>
        <p>Зарим хэрэглэгч олдохгүй байна. Энэ хүсэлтийг зөвхөн татгалзах боломжтой.</p>
    </div>
    {% else %}
    <h4 class="mt-4">Нэгтгэх</h4>
    <form method="post" action="{% url 'merge_request_approve' merge_request.id %}" id="mergeForm">
        {% csrf_token %}

        {# Primary user selection #}
        <div class="card mb-3">
            <div class="card-header"><h5 class="mb-0">Үндсэн хэрэглэгч сонгох</h5></div>
            <div class="card-body">
                <p class="text-muted">Нэгтгэсний дараа аль хэрэглэгчийн бүртгэл үлдэхийг сонгоно уу.</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th width="50">Сонгох</th>
                                <th>ID</th>
                                <th>Овог</th>
                                <th>Нэр</th>
                                <th>Имэйл</th>
                                <th>Сургууль</th>
                                <th>РД</th>
                                <th>Утас</th>
                                <th>Сүүлд нэвтэрсэн</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>
                                    <input type="radio" name="primary_user_id" value="{{ user.id }}"
                                           class="form-check-input"
                                           {% if user.id == primary_id %}checked{% endif %}>
                                </td>
                                <td>{{ user.id }}</td>
                                <td>{{ user.last_name }}</td>
                                <td>{{ user.first_name }}</td>
                                <td>{{ user.email }}</td>
                                <td>{% if user.data and user.data.school %}{{ user.data.school.name }}{% else %}-{% endif %}</td>
                                <td>{% if user.data %}{{ user.data.reg_num|default:"-" }}{% else %}-{% endif %}</td>
                                <td>{% if user.data %}{{ user.data.mobile|default:"-" }}{% else %}-{% endif %}</td>
                                <td>{% if user.last_login %}{{ user.last_login|date:"Y-m-d H:i" }}{% else %}-{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {# Field comparison and selection #}
        <div class="card mb-3">
            <div class="card-header"><h5 class="mb-0">Мэдээлэл харьцуулж сонгох</h5></div>
            <div class="card-body">
                {% if saved_field_selections %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Хүсэлт илгээгч сонгосон утгууд:</strong>
                    урьдчилан сонгосон утгуудыг доор тэмдэглэсэн. Та өөрчилж болно.
                </div>
                {% endif %}
                <p class="text-muted">Зөрүүтэй талбаруудыг шар өнгөөр тэмдэглэсэн — аль утгыг авахаа сонгоно уу.</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Талбар</th>
                                {% for u in users %}
                                <th {% if u.id == primary_id %}class="table-primary"{% endif %}>
                                    ID:{{ u.id }}
                                    {% if u.id == primary_id %}<span class="badge bg-primary">Үндсэн</span>{% endif %}
                                </th>
                                {% endfor %}
                                <th>Сонголт</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for field in compare_fields %}
                            <tr class="{% if field.is_different %}table-warning{% endif %}">
                                <td><strong>{{ field.label }}</strong></td>
                                {% for v in field.values %}
                                <td {% if v.user_id == primary_id %}class="table-primary"{% endif %}>
                                    {{ v.value|default:"-" }}
                                </td>
                                {% endfor %}
                                <td>
                                    {% if field.all_empty and field.name == "school" %}
                                        <select name="field_school" class="form-select form-select-sm">
                                            <option value="">-- Сургууль сонгох --</option>
                                            {% for s in all_schools %}
                                            <option value="{{ s.id }}">{{ s.name }}</option>
                                            {% endfor %}
                                        </select>
                                    {% elif field.all_empty and field.field_type != "meta_fk" %}
                                        <input type="text" name="field_{{ field.name }}"
                                               class="form-control form-control-sm"
                                               placeholder="{{ field.label }} оруулах">
                                    {% elif field.is_different %}
                                        {% for v in field.values %}
                                            {% if v.raw_value %}
                                            <div class="form-check">
                                                <input type="radio"
                                                       name="field_{{ field.name }}"
                                                       value="{{ v.raw_value }}"
                                                       class="form-check-input field-radio"
                                                       data-field="{{ field.name }}"
                                                       id="field_{{ field.name }}_{{ v.user_id }}"
                                                       {% if v.raw_value == field.auto_selected %}checked{% endif %}>
                                                <label class="form-check-label" for="field_{{ field.name }}_{{ v.user_id }}">
                                                    {{ v.value }}
                                                </label>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                        {% if field.name == "school" %}
                                        <div class="form-check">
                                            <input type="radio" name="field_school" value="__other_school__"
                                                   class="form-check-input field-radio" data-field="school"
                                                   id="field_school_other">
                                            <label class="form-check-label" for="field_school_other">Бусад сургууль</label>
                                        </div>
                                        <select class="form-select form-select-sm mt-1 d-none" id="schoolSelect">
                                            <option value="">-- Сургууль сонгох --</option>
                                            {% for s in all_schools %}
                                            <option value="{{ s.id }}">{{ s.name }}</option>
                                            {% endfor %}
                                        </select>
                                        {% elif field.field_type != "meta_fk" %}
                                        <div class="form-check">
                                            <input type="radio" name="field_{{ field.name }}" value="__custom__"
                                                   class="form-check-input field-radio" data-field="{{ field.name }}"
                                                   id="field_{{ field.name }}_custom">
                                            <label class="form-check-label" for="field_{{ field.name }}_custom">Гараар бичих</label>
                                        </div>
                                        <input type="text" class="form-control form-control-sm mt-1 custom-input d-none"
                                               data-field="{{ field.name }}" placeholder="{{ field.label }} оруулах">
                                        {% endif %}
                                    {% else %}
                                        {% if field.name == "school" %}
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="hidden" name="field_school" value="{{ field.auto_selected }}"
                                                   class="same-value-hidden" data-field="school" id="schoolHidden">
                                            <span class="text-muted same-value-text" data-field="school">{{ field.auto_selected_display|default:"-" }}</span>
                                            <button type="button" class="btn btn-outline-secondary btn-sm py-0 px-1"
                                                    id="schoolChangeBtn" title="Бусад сургууль">
                                                <i class="fas fa-pen fa-xs"></i>
                                            </button>
                                        </div>
                                        <select class="form-select form-select-sm mt-1 d-none" id="schoolSelectSame">
                                            <option value="">-- Бусад сургууль сонгох --</option>
                                            {% for s in all_schools %}
                                            <option value="{{ s.id }}" {% if s.id|stringformat:"d" == field.auto_selected %}selected{% endif %}>{{ s.name }}</option>
                                            {% endfor %}
                                        </select>
                                        {% elif field.field_type != "meta_fk" %}
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="hidden" name="field_{{ field.name }}" value="{{ field.auto_selected }}"
                                                   class="same-value-hidden" data-field="{{ field.name }}">
                                            <span class="text-muted same-value-text" data-field="{{ field.name }}">{{ field.auto_selected_display|default:"-" }}</span>
                                            <button type="button" class="btn btn-outline-secondary btn-sm edit-btn py-0 px-1"
                                                    data-field="{{ field.name }}" title="Засах">
                                                <i class="fas fa-pen fa-xs"></i>
                                            </button>
                                        </div>
                                        <input type="text" class="form-control form-control-sm mt-1 edit-input d-none"
                                               data-field="{{ field.name }}" value="{{ field.auto_selected }}"
                                               placeholder="{{ field.label }} оруулах">
                                        {% else %}
                                        <input type="hidden" name="field_{{ field.name }}" value="{{ field.auto_selected }}">
                                        <span class="text-muted">{{ field.auto_selected_display|default:"-" }}</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {# Result conflict resolution #}
        {% if result_conflicts %}
        <div class="card mb-3 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Дүнгийн зөрчил ({{ result_conflicts|length }})</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Давхардсан дүнгүүд байна. Аль хэрэглэгчийн дүнг авахаа сонгоно уу.</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Олимпиад</th>
                                <th>Бодлого</th>
                                <th>Үндсэн (ID:{{ primary_id }})</th>
                                <th>Давхардсан</th>
                                <th>Сонголт</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in result_conflicts %}
                            <tr>
                                <td>{{ c.olympiad_name }}</td>
                                <td>Бодлого №{{ c.problem_order }}</td>
                                <td>
                                    Хариулт: <strong>{{ c.primary_answer }}</strong>,
                                    Оноо: <strong>{{ c.primary_score }}</strong>
                                </td>
                                <td>
                                    ID:{{ c.dup_user_id }} {{ c.dup_user_name }}<br>
                                    Хариулт: <strong>{{ c.dup_answer }}</strong>,
                                    Оноо: <strong>{{ c.dup_score }}</strong>
                                </td>
                                <td>
                                    <div class="form-check">
                                        <input type="radio" name="{{ c.key }}" value="primary"
                                               class="form-check-input" id="{{ c.key }}_primary" checked>
                                        <label class="form-check-label" for="{{ c.key }}_primary">
                                            Үндсэн (оноо: {{ c.primary_score }})
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" name="{{ c.key }}" value="dup"
                                               class="form-check-input" id="{{ c.key }}_dup">
                                        <label class="form-check-label" for="{{ c.key }}_dup">
                                            Давхардсан (оноо: {{ c.dup_score }})
                                        </label>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {# Review notes and submit #}
        <div class="card mb-3">
            <div class="card-body">
                <div class="mb-3">
                    <label for="review_notes" class="form-label">Тайлбар (заавал биш)</label>
                    <textarea name="review_notes" id="review_notes" class="form-control" rows="2"></textarea>
                </div>

                <button type="submit" class="btn btn-success" id="mergeBtn">
                    <i class="fas fa-check"></i> Зөвшөөрч, нэгтгэх
                </button>
            </div>
        </div>
    </form>
    {% endif %}

    {# Reject form #}
    <div class="card mt-3">
        <div class="card-body">
            <form method="post" action="{% url 'merge_request_reject' merge_request.id %}">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="reject_review_notes" class="form-label">Татгалзах шалтгаан</label>
                    <textarea name="review_notes" id="reject_review_notes" class="form-control" rows="2" required></textarea>
                </div>
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-times"></i> Татгалзах
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Review History -->
    {% if merge_request.reviewed_at %}
    <div class="card mt-3">
        <div class="card-header">
            <strong>Хянасан мэдээлэл</strong>
        </div>
        <div class="card-body">
            <p><strong>Хянасан хэрэглэгч:</strong> {{ merge_request.reviewed_by.last_name }} {{ merge_request.reviewed_by.first_name }}</p>
            <p><strong>Хянасан огноо:</strong> {{ merge_request.reviewed_at|date:"Y-m-d H:i" }}</p>
            {% if merge_request.review_notes %}
            <p><strong>Тайлбар:</strong> {{ merge_request.review_notes }}</p>
            {% endif %}
            {% if merge_request.merge_error %}
            <p class="text-danger"><strong>Алдаа:</strong> {{ merge_request.merge_error }}</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div class="mt-4">
        <a href="{% url 'merge_requests_list' %}" class="btn btn-secondary me-2">
            <i class="fas fa-list"></i> Хүсэлтүүдийн жагсаалт
        </a>
        <a href="{% url 'participant_search' %}" class="btn btn-outline-secondary">
            <i class="fas fa-search"></i> Оролцогч хайх
        </a>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.table td, .table th {
    vertical-align: middle;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var mergeForm = document.getElementById('mergeForm');
    if (!mergeForm) return;

    // School "other" radio → show dropdown
    var schoolSelect = document.getElementById('schoolSelect');
    mergeForm.querySelectorAll('.field-radio').forEach(function(radio) {
        radio.addEventListener('change', function() {
            var field = this.dataset.field;
            if (field === 'school' && schoolSelect) {
                if (this.value === '__other_school__') {
                    schoolSelect.classList.remove('d-none');
                    schoolSelect.focus();
                } else {
                    schoolSelect.classList.add('d-none');
                }
                return;
            }
            var customInput = mergeForm.querySelector('.custom-input[data-field="' + field + '"]');
            if (!customInput) return;
            if (this.value === '__custom__') {
                customInput.classList.remove('d-none');
                customInput.focus();
            } else {
                customInput.classList.add('d-none');
            }
        });
    });

    // School "same value" change button
    var schoolChangeBtn = document.getElementById('schoolChangeBtn');
    var schoolSelectSame = document.getElementById('schoolSelectSame');
    var schoolHidden = document.getElementById('schoolHidden');
    if (schoolChangeBtn && schoolSelectSame) {
        schoolChangeBtn.addEventListener('click', function() {
            var textSpan = mergeForm.querySelector('.same-value-text[data-field="school"]');
            if (schoolHidden) schoolHidden.remove();
            if (textSpan) textSpan.classList.add('d-none');
            schoolChangeBtn.classList.add('d-none');
            schoolSelectSame.classList.remove('d-none');
            schoolSelectSame.name = 'field_school';
            schoolSelectSame.focus();
        });
    }

    // Edit buttons for same-value fields
    mergeForm.querySelectorAll('.edit-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var field = this.dataset.field;
            var hiddenInput = mergeForm.querySelector('.same-value-hidden[data-field="' + field + '"]');
            var textSpan = mergeForm.querySelector('.same-value-text[data-field="' + field + '"]');
            var editInput = mergeForm.querySelector('.edit-input[data-field="' + field + '"]');
            hiddenInput.remove();
            textSpan.classList.add('d-none');
            this.classList.add('d-none');
            editInput.classList.remove('d-none');
            editInput.name = 'field_' + field;
            editInput.focus();
        });
    });

    // Submit handling
    mergeForm.addEventListener('submit', function(e) {
        // Replace __custom__ values with actual input
        mergeForm.querySelectorAll('.custom-input').forEach(function(input) {
            var field = input.dataset.field;
            var selectedRadio = mergeForm.querySelector('input[name="field_' + field + '"]:checked');
            if (selectedRadio && selectedRadio.value === '__custom__') {
                selectedRadio.value = input.value.trim();
            }
        });
        // Replace __other_school__ with selected school
        var schoolRadio = mergeForm.querySelector('input[name="field_school"]:checked');
        if (schoolRadio && schoolRadio.value === '__other_school__' && schoolSelect) {
            schoolRadio.value = schoolSelect.value;
        }

        if (!confirm('Нэгтгэлт буцаагдахгүй. Давхар хэрэглэгчийн бүртгэл устгагдана. Үргэлжлүүлэх үү?')) {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}
