{% extends 'base.html' %}
{% load static %}

{% block title %}Оролцогч хайх{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="mb-3">
        <h2><i class="fas fa-search"></i> Оролцогч хайх</h2>
        <p class="text-muted mb-0">Оролцогчийн мэдээлэл хайх</p>
    </div>

    <!-- Search Form -->
    <form method="get" class="mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <input type="text" name="q" class="form-control"
                       placeholder="Овог=Бат, Нэр=Дорж ..."
                       value="{{ search_query }}">
                <div class="form-text">
                    <a href="#" data-bs-toggle="collapse" data-bs-target="#searchHelp" class="text-decoration-none">
                        <small>Хайлтын заавар</small>
                    </a>
                    <div class="collapse" id="searchHelp">
                        <div class="mt-1">
                            <small class="text-muted">
                                <strong>Энгийн хайлт:</strong> нэр, овог, ID{% if request.user.is_staff %}, регистр, утас, имэйл{% endif %}-аар хайна<br>
                                <strong>Нарийвчилсан хайлт:</strong> талбар=утга таслалаар зааглана (AND логик)<br>
                                <code>id=123</code> <code>username=bat</code> <code>Овог=Бат</code> <code>Нэр=Дорж</code>
                                {% if request.user.is_staff %}<code>Регистр=УБ</code> <code>Утас=9911</code> <code>Имэйл=bat@</code> {% endif %}<code>Сургууль=1-р</code> <code>Аймаг=УБ</code><br>
                                Жишээ: <code>Овог=Бат, Аймаг=Дорнод</code>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <select name="p" id="id_province" class="form-select">
                    <option value="">Аймаг/Дүүрэг</option>
                    {% for province in provinces %}
                    <option value="{{ province.id }}"
                            {% if selected_province == province.id|stringformat:"s" %}selected{% endif %}>
                        {{ province.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select name="z" class="form-select">
                    <option value="">Бүс</option>
                    {% for zone in zones %}
                    <option value="{{ zone.id }}"
                            {% if selected_zone == zone.id|stringformat:"s" %}selected{% endif %}>
                        {{ zone.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select name="s" id="id_school" class="form-select">
                    <option value="">Сургууль</option>
                    {% for school in schools %}
                    <option value="{{ school.id }}"
                            {% if selected_school == school.id|stringformat:"s" %}selected{% endif %}>
                        {{ school.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search"></i> Хайх
                </button>
            </div>
        </div>
    </form>

    <!-- Results Table -->
    <div class="table-responsive">
        <table class="table table-hover table-sm">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ID</th>
                    <th>Овог</th>
                    <th>Нэр</th>
                    <th>Аймаг</th>
                    <th>Сургууль</th>
                    <th>Анги</th>
                    {% if request.user.is_staff %}
                    <th><span class="text-danger" title="Зөвхөн админ харна">Регистр *</span></th>
                    <th><span class="text-danger" title="Зөвхөн админ харна">Утас *</span></th>
                    <th><span class="text-danger" title="Зөвхөн админ харна">Имэйл *</span></th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ user.id }}</td>
                    <td>{{ user.last_name }}</td>
                    <td>{{ user.first_name }}</td>
                    <td>{% if user.data and user.data.province %}{{ user.data.province.name }}{% endif %}</td>
                    <td>{% if user.data and user.data.school %}{{ user.data.school.name }}{% endif %}</td>
                    <td>{% if user.data and user.data.grade %}{{ user.data.grade.name }}{% endif %}</td>
                    {% if request.user.is_staff %}
                    <td>{% if user.data and user.data.reg_num %}<a href="?q=Регистр={{ user.data.reg_num }}">{{ user.data.reg_num }}</a>{% endif %}</td>
                    <td>{% if user.data and user.data.mobile %}<a href="?q=Утас={{ user.data.mobile }}">{{ user.data.mobile }}</a>{% endif %}</td>
                    <td>{% if user.email %}<a href="?q=Имэйл={{ user.email }}">{{ user.email }}</a>{% endif %}</td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{% if request.user.is_staff %}10{% else %}7{% endif %}" class="text-center text-muted py-4">
                        {% if search_query or selected_province or selected_zone or selected_school %}
                        Хайлт олдсонгүй
                        {% else %}
                        Хайлт хийхийн тулд дээрх шүүлтүүрийг ашиглана уу
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if users.has_other_pages %}
    <nav>
        <ul class="pagination">
            {% if users.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ users.previous_page_number }}&q={{ search_query }}&p={{ selected_province }}&z={{ selected_zone }}&s={{ selected_school }}">Өмнөх</a>
            </li>
            {% endif %}
            <li class="page-item active">
                <span class="page-link">{{ users.number }} / {{ users.paginator.num_pages }}</span>
            </li>
            {% if users.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ users.next_page_number }}&q={{ search_query }}&p={{ selected_province }}&z={{ selected_zone }}&s={{ selected_school }}">Дараах</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
// AJAX school loading based on province selection
document.getElementById('id_province').addEventListener('change', function() {
    const provinceId = this.value;
    const schoolSelect = document.getElementById('id_school');

    schoolSelect.innerHTML = '<option value="">Сургууль</option>';

    if (provinceId) {
        fetch(`/accounts/ajax/load-schools/?province_id=${provinceId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school.id;
                    option.textContent = school.name;
                    schoolSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading schools:', error));
    }
});
</script>
{% endblock %}
